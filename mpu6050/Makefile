
SHELL = /bin/bash

CC=$(CROSS_COMPILE)gcc -g

GLOBAL_CFLAGS =  -Wextra  -Wno-int-to-pointer-cast -Wno-int-conversion -std=gnu99 -g -O0

OUTPUT_DIR?=output

include library/library.mk
include example/example.mk
include driver/driver.mk

.PHONY: all $(OUTPUT_DIR)

all: library examples  drivers


$(OUTPUT_DIR):
	@mkdir -p $(OUTPUT_DIR)

clean: drivers_clean library_clean examples_clean

# Check that the specified cross-compiler exists
cross_compiler_check:
ifdef CROSS_COMPILE
ifeq (,$(shell which $(CC)))
	@printf "Error: '$(CROSS_COMPILE)' is not a valid cross-compiler prefix. "
	@printf "'$(#CC)' was not found in your path.\n"
	@exit 1
endif
endif



help:
	@printf "Usage:\n"
	@printf "\tmake [target] [variable] ...\n"
	@printf "\n"
	@printf "Targets:\n"
	@printf "\tall (default)\n"
	@printf "\t    The default target. Compiles all components.\n"
	@printf "\n"
	@printf "\tclean\n"
	@printf "\t    Cleans up all intermediate files generated by compilation\n"
	@printf "\t    of the driver and example programs.\n"
	@printf "\n"
	@printf "\tdriver\n"
	@printf "\t    Compiles the AXI DMA driver. The kernel object file can be\n"
	@printf "\t    found at '\$$(OUTPUT_DIR)/axidma.ko'.\n"
	@printf "\n"
	@printf "\tdriver_clean\n"
	@printf "\t    Cleans up files generated by the driver's compilation.\n"
	@printf "\n"
	@printf "\tlibrary\n"
	@printf "\t    Compiles the AXI DMA library. The shared library file can\n"
	@printf "\t    be found at '\$$(OUTPUT_DIR)/libaxidma.so'.\n"
	@printf "\n"
	@printf "\tlibrary_clean\n"
	@printf "\t    Cleans up the files generated by compiling the library.\n"
	@printf "\n"
	@printf "\texamples, <example_name>\n"
	@printf "\t    Compiles the example programs or specific example program.\n"
	@printf "\t    The executable for a given example can be found at\n"
	@printf "\t    '\$$(OUTPUT_DIR)/<example name>'.\n"
	@printf "\n"
	@printf "\texamples_clean\n"
	@printf "\t    Cleans up files generated by compiling the examples.\n"
	@printf "\n"
	@printf "\thelp\n"
	@printf "\t    Display this help message.\n"
	@printf "\n"
	@printf "Variables:\n"
	@printf "\tThe variables can be specified either on the command line or\n"
	@printf "\tin 'config.mk'. See 'config_template.mk' for a template of the\n"
	@printf "\tMakefile configuration file and more detailed explanations.\n"
	@printf "\n"
	@printf "\tCROSS_COMPILE\n"
	@printf "\t    The prefix for the cross compiler to use for compilation.\n"
	@printf "\t    For example, \`arm-linux-gnueabi-\`. Not required; if left\n"
	@printf "\t    unspecified, then the system default compiler is used.\n"
	@printf "\n"
	@printf "\tARCH\n"
	@printf "\t    The architecture that the code is being compiled for.\n"
	@printf "\t    Only needed when cross-compiling the driver.\n"
	@printf "\n"
	@printf "\tKBUILD_DIR\n"
	@printf "\t    The path to the kernel source tree to build the driver\n"
	@printf "\t    against. Required when cross-compiling the driver.\n"
	@printf "\t    Otherwise, may be left unspecified. If it is, the system\n"
	@printf "\t    default is used.\n"
	@printf "\n"
	@printf "\tOUTPUT_DIR\n"
	@printf "\t    The path where the generated code files (both the kernel \n"
	@printf "\t    object file and executables) will be stored. The default \n"
	@printf "\t    is the "outputs" in the top-level directory.\n"
	@printf "\n"
	@printf "\tXILINX_DMA_INCLUDE_PATH_FIXUP\n"
	@printf "\t    Specifies to fix and issue with the location of the header\n"
	@printf "\t    file 'xilinx_dma.h' in the kernel you're compiling against\n"
	@printf "\t    Specify if you see an include error when compiling.\n"
	@printf "\n"
	@printf "Examples:\n"
	@printf "\tmake\n"
	@printf "\tmake CROSS_COMPILE=arm-linux-gnueabihf- ARCH=arm "
	@printf "KBUILD_DIR=/home/kernels/linux/ driver\n"
	@printf "\tmake CROSS_COMPILE=arm-linux-gnueabihf- OUTPUT_DIR=outputs "
	@printf "examples\n"
	@printf "\tmake axidma_benchmark\n"
	@printf "\tmake OUTPUT_DIR=outputs clean\n"
